import can
ERROR_CODES = {
    0x0000: "Error reset or no error",
    0x1000: "Generic error",
    0x1010: "Flash write error",
    0x1030: "Termination Board not supported",
    0x1040: "FPGA configuration error",
    0x1041: "FPGA channel configuration corrupted",
    0x2000: "Current",
    0x2010: "Earth Fault (Leak current)",
    0x2011: "Module over-current",
    0x2100: "Current, CANopen device input side",
    0x2200: "Current inside the CANopen device",
    0x2300: "Current, CANopen device output side",
    0x3000: "Voltage",
    0x3100: "Mains voltage",
    0x3110: "Supply overvoltage fault",
    0x3111: "Supply voltage measurement outside legal range",
    0x3200: "Voltage inside the CANopen device",
    0x3300: "Output voltage",
    0x4000: "Temperature",
    0x4100: "Ambient Temperature",
    0x4110: "Ambient temperature out of range",
    0x4200: "Device temperature",
    0x4210: "PSU temperature out of range",
    0x4220: "MCU temperature out of range",
    0x4230: "CPU temperature out of range",
    0x5000: "Device Hardware",
    0x5010: "NVM corrupted",
    0x5011: "Single bit ECC error (count limit exceeded)",
    0x5020: "IO Frontend ADC error",
    0x5021: "IO Frontend DAC error",
    0x5022: "IO Frontend ADC stuck bit",
    0x5030: "Termination Board EEPROM corrupted",
    0x5040: "Thermometer error (I2C error)",
    0x6000: "Device Software",
    0x6100: "Internal software",
    0x6110: "FW integrity error",
    0x6111: "FPGA FW integrity error",
    0x6120: "IO framework not started",
    0x6200: "User software",
    0x6300: "Data set",
    0x6310: "Calibration data missing",
    0x6311: "Calibration data error",
    0x6320: "Module type info missing",
    0x6321: "Module type info error",
    0x6322: "Module info missing",
    0x6323: "Module info error",
    0x6330: "Manufacturer test data missing",
    0x6331: "Manufacturer test data error",
    0x6340: "Configuration data error",
    0x6341: "Stored OD file error",
    0x6350: "Logging data error",
    0x7000: "Additional modules",
    0x8000: "Monitoring",
    0x8010: "SW watchdog error",
    0x8020: "HW watchdog error",
    0x8030: "FPGA ADC data error (from FPGA)",
    0x8031: "FPGA DAC data error (to FPGA)",
    0x8100: "Communication",
    0x8110: "CAN overrun (objects lost)",
    0x8120: "CAN in error passive mode",
    0x8130: "Lifeguard error or heartbeat error",
    0x8140: "Recovered from bus off",
    0x8150: "CAN-ID collision",
    0x8180: "DCL failure",
    0x8181: "RCL failure",
    0x8200: "Protocol error",
    0x8210: "PDO not processed due to length error",
    0x8220: "PDO length exceeded",
    0x8230: "DAM MPDO not processed, destination object not available",
    0x8240: "Unexpected SYNC data length",
    0x8250: "RPDO timeout",
    0x9000: "External error",
    0xF000: "Additional functions",
    0xFF00: "Device specific",
    # Additional error codes
    0x1080: "General Warning",
    0x1081: "General Error",
    0x3110: "DC Bus link over voltage FPGA",
    0x3120: "DC Bus link voltage exceed allowed thresholds",
    0x3130: "DC Bus link capacitor overload",
    0x3180: "Warning: DC Bus link capacitor overload",
    0x3210: "DC Bus link over-voltage",
    0x3220: "DC Bus Link under-voltage",
    0x3280: "Warning: DC Bus Link under-voltage",
    0x3281: "Warning: Dynamic Braking Iï¿½T",
    0x3282: "Regen short circuit",
    0x3283: "Warning: DC Bus link over-voltage",
    0x4210: "Excessive temperature, device (control board)",
    0x4310: "Excessive temperature, drive (heat sink)",
    0x4380: "Power temperature sensor 2 high",
    0x4381: "Power temperature sensor 3 high",
    0x4382: "Power board overtemperature",
    0x4390: "Warning: Control temperature sensor 1 high",
    0x4391: "Warning: Power temperature sensor 1 high",
    0x4392: "Warning: Power temperature sensor 2 high",
    0x4393: "Warning: Power temperature sensor 3 high",
    0x4394: "Warning: Control temperature sensor 1 low",
    0x4395: "Warning: Power temperature sensor 1 low",
    0x4396: "Warning: Power temperature sensor 2 low",
    0x4397: "Warning: Control temperature sensor 1 low",
    0x4398: "Control temperature sensor 1 low",
    0x4399: "Power temperature sensor 1 low",
    0x439A: "Power temperature sensor 2 low",
    0x439B: "Power temperature sensor 3 low",
    0x5113: "5V0 under voltage",
    0x5114: "1V2 under voltage",
    0x5115: "2V5 under voltage",
    0x5116: "3V3 under voltage",
    0x5117: "+12V0 under voltage",
    0x5118: "-12V0 under voltage",
    0x5119: "Analog 3V3 under voltage",
    0x5180: "1V2 over voltage",
    0x5181: "2V5 over voltage",
    0x5182: "3V3 over voltage",
    0x5183: "5V0 over voltage",
    0x5184: "+12V0 over voltage",
    0x5185: "-12V0 over voltage",
    0x5186: "Analog 3V3 over voltage",
    0x5530: "Hardware memory, non-volatile memory stamp invalid",
    0x5580: "Hardware memory, non-volatile memory data",
    0x5589: "Cogging compensation non volatile memory data error (CRC)",
    0x5590: "Control board EEPROM read failed",
    0x5591: "Control board EEPROM corrupted serial num stamp",
    0x5592: "Control board EEPROM corrupted serial num data",
}


def parse_canopen_emcy_message(msg: can.Message):
    valueStart = 0
    errorCode = (msg.data[valueStart] + (msg.data[valueStart + 1] << 8) + (
                msg.data[valueStart + 2] << 16) + (msg.data[valueStart + 3] << 24))
    if errorCode in ERROR_CODES:
        return f"EMCY N:{msg.arbitration_id & 0x7F} {errorCode:x} {ERROR_CODES[errorCode]}"
    else:
        return f"EMCY {msg}"

